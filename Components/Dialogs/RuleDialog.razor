@using PangolinWatchdog.Data
@using MudBlazor
@using System.Text.RegularExpressions
@inject AppDbContext Db

<MudDialog>
    <DialogContent>
        <MudTextField T="string" Label="Rule Name" @bind-Value="Rule.Name" Required="true" />
        
        <MudStack Row="true" Class="mt-4" AlignItems="AlignItems.Center">
            <MudSwitch T="bool" Label="Use Regex" Color="Color.Secondary" @bind-Value="Rule.UseRegex" />
            
            <MudTextField T="string" Label="@(Rule.UseRegex ? "Regex Pattern" : "Exact Match")" 
                          @bind-Value="Rule.Pattern" 
                          HelperText="@(Rule.UseRegex ? "e.g. wp-.*|xmlrpc" : "e.g. /config.php")" 
                          Required="true" 
                          Immediate="true"/> 
        </MudStack>

        @if (Rule.UseRegex)
        {
            <MudPaper Class="pa-4 my-4 mud-theme-dark" Elevation="0" Outlined="true">
                <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="mb-2">Regex Tester</MudText>
                
                @{
                    var result = GetTesterResult();
                }

                <MudGrid>
                    <MudItem xs="8">
                        <MudTextField T="string" @bind-Value="_testString" 
                                      Label="Test String (e.g. /wp-admin/login.php)" 
                                      Variant="Variant.Filled" 
                                      Margin="Margin.Dense"
                                      FullWidth="true"
                                      Immediate="true" />
                    </MudItem>
                    <MudItem xs="4" Class="d-flex align-center">
                        <MudChip T="string" Icon="@result.Icon" Color="@result.Color" Variant="Variant.Filled">
                            @result.Text
                        </MudChip>
                    </MudItem>
                </MudGrid>
                
                @if(result.Color == Color.Error && result.Text == "Invalid Syntax")
                {
                    <MudText Typo="Typo.caption" Color="Color.Error">Check your regex syntax (e.g. unclosed parenthesis).</MudText>
                }
            </MudPaper>
        }
        <MudNumericField T="int?" Label="Ban Duration (Minutes)" 
                         @bind-Value="Rule.BanDurationMinutes" 
                         Min="1" 
                         Class="mt-4"
                         HelperText="Leave empty to use global default" />

        <MudDivider Class="my-4"/>

        <MudSwitch T="bool" Label="Global Rule" Color="Color.Primary" @bind-Value="Rule.IsGlobal" />

        @if (Rule.IsGlobal)
        {
            <MudSelect T="long" Label="Excluded Resources (Optional)" 
                       @bind-SelectedValues="_selectedExclusions" 
                       MultiSelection="true"
                       Class="my-4"
                       HelperText="Select resources to exclude from this global rule">
                @foreach (var resource in _resources)
                {
                    <MudSelectItem T="long" Value="@resource.Id">@resource.Name</MudSelectItem>
                }
            </MudSelect>
        }
        else
        {
            <MudSelect T="long?" Label="Target Resource" @bind-Value="Rule.TargetResourceId" Class="my-4" Required="true">
                @foreach (var resource in _resources)
                {
                    <MudSelectItem T="long?" Value="@resource.Id">@resource.Name</MudSelectItem>
                }
            </MudSelect>
        }

        <MudNumericField T="long?" Label="Max Priority (Optional)" 
                         @bind-Value="Rule.MaxPriority" 
                         Min="1" 
                         Class="mt-4"
                         HelperText="This rule will be disabled if a new block rule with higher priority is added" />

        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mt-2">
            <MudText Typo="Typo.caption" Style="white-space:normal; max-width:420px;">Use this setting if you have global 'allow' rules</MudText>
            <MudTooltip>
                <ChildContent>
                    <MudIcon Icon="@Icons.Material.Filled.HelpOutline" Size="Size.Small" Class="ml-2"/>
                </ChildContent>
                <TooltipContent>
                    <MudText>Useful when you have global 'allow' rules and want to work after IP blocking rules</MudText>
                    <MudText Class="mt-2">
                        For example, if you have a global 'allow' rule for country X with priority 100, and you set this rule's Max Priority to 100,
                    </MudText>
                    <MudText>new blocking rules will be added before the 100 priority 'allow' rule, ensuring they are evaluated first.</MudText>
                    <MudText>If you reach the Max Priority limit, this rule will be automatically disabled.</MudText>
                </TooltipContent>
            </MudTooltip>

        </MudStack>

        <MudDivider Class="my-4"/>

        <MudSwitch T="bool" Label="Active" Color="Color.Success" @bind-Value="Rule.IsActive" />

    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public WatchdogRule Rule { get; set; } = new();

    private string _testString = "";
    private List<Resource> _resources = new();
    private IEnumerable<long> _selectedExclusions = new HashSet<long>();

    protected override void OnInitialized()
    {
        _resources = Db.Resources.OrderBy(r => r.Name).ToList();
        
        if (Rule.Id > 0)
        {
            _selectedExclusions = Db.RuleResourceExclusions
                .Where(e => e.RuleId == Rule.Id)
                .Select(e => e.ResourceId)
                .ToList();
        }
    }

    void Submit()
    {
        Rule.ExcludedResources = _selectedExclusions
            .Select(resourceId => new RuleResourceExclusion 
            { 
                RuleId = Rule.Id, 
                ResourceId = resourceId 
            })
            .ToList();
        
        MudDialog.Close(DialogResult.Ok(Rule));
    }
    
    void Cancel() => MudDialog.Cancel();

    private (string Icon, Color Color, string Text) GetTesterResult()
    {
        if (string.IsNullOrWhiteSpace(_testString))
            return (Icons.Material.Filled.Help, Color.Default, "Waiting...");

        if (string.IsNullOrWhiteSpace(Rule.Pattern))
            return (Icons.Material.Filled.Help, Color.Default, "No Pattern");

        try
        {
            var match = Regex.IsMatch(_testString, Rule.Pattern, RegexOptions.IgnoreCase);
            if (match) 
                return (Icons.Material.Filled.CheckCircle, Color.Success, "MATCH");
            
            return (Icons.Material.Filled.Cancel, Color.Error, "NO MATCH");
        }
        catch
        {
            return (Icons.Material.Filled.Error, Color.Error, "Invalid Syntax");
        }
    }
}