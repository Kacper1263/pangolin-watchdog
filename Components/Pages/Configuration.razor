@page "/configuration"
@using Microsoft.AspNetCore.Authorization
@using PangolinWatchdog.Data
@using Microsoft.EntityFrameworkCore
@using PangolinWatchdog.Services.Pangolin
@using PangolinWatchdog.DTO.Pangolin
@attribute [Authorize]
@inject AppDbContext Db
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject PangolinConnector PangolinConnector
@rendermode InteractiveServer

<PageTitle>Configuration</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">System Configuration</MudText>

<MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
    
    <MudTabPanel Text="General Settings" Icon="@Icons.Material.Filled.Settings">
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudCard>
                    <MudCardContent>
                        <MudText Typo="Typo.h6">Pangolin API</MudText>
                        <MudTextField @bind-Value="_config.PangolinApiUrl" Label="API URL" Variant="Variant.Text" />
                        <MudAutocomplete T="PangolinOrgEntry" 
                                         Label="Organization ID" 
                                         Value="_selectedOrg"
                                         ValueChanged="OnOrgSelected"
                                         SearchFunc="@SearchOrgs"
                                         ResetValueOnEmptyText="false"
                                         ShowProgressIndicator="@_loadingOrgs"
                                         ToStringFunc="@(org => org == null ? _config.PangolinOrgId : $"{org.OrgId} ({org.Name})")"
                                         Variant="Variant.Text"
                                         HelperText="Type or click to load organizations" />
                        <MudTextField @bind-Value="_config.PangolinApiToken" Label="API Token" InputType="InputType.Password" Variant="Variant.Text" />
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudCard>
                    <MudCardContent>
                        <MudText Typo="Typo.h6">Watchdog Timers</MudText>
                        <MudNumericField @bind-Value="_config.LogPollingIntervalSeconds" Label="Log Polling Interval (Seconds)" Min="10" />
                        <MudNumericField @bind-Value="_config.BanCleanupIntervalMinutes" Label="Ban Cleanup Interval (Minutes)" Min="5" />
                        <MudNumericField @bind-Value="_config.DefaultBanDurationMinutes" Label="Default Ban Duration (Minutes)" Min="1" />
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" Class="d-flex justify-end gap-2">
                <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="@(() => OpenIpWhitelistDialog())" StartIcon="@Icons.Material.Filled.List">
                    Manage whitelisted IPs
                </MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="RefreshResources" StartIcon="@Icons.Material.Filled.Refresh">
                    Refresh Resources list
                </MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveConfig" StartIcon="@Icons.Material.Filled.Save">
                    Save Settings
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudTabPanel>

    <MudTabPanel Text="Blocking Rules" Icon="@Icons.Material.Filled.Security">
        <MudTable Items="@_rules" Hover="true" Elevation="0" Breakpoint="Breakpoint.None" Dense="true">
            <ToolBarContent>
                <MudText Typo="Typo.h6">Defined Rules</MudText>
                <MudSpacer />
                <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="@(() => OpenRuleDialog(null))">
                    Add Rule
                </MudButton>
            </ToolBarContent>
            <HeaderContent>
                <MudTh Style="width: 1%;">Status</MudTh>
                <MudTh Style="width: 15%;">Name</MudTh>
                <MudTh Style="width: 30%;">Pattern</MudTh>
                <MudTh Style="width: 12%;">Scope</MudTh>
                <MudTh Style="width: 5%;">Ban Time</MudTh>
                <MudTh Style="width: 13%;">Actions</MudTh>
            </HeaderContent>
            <RowTemplate Context="rule">
                <MudTd Style="vertical-align: top;">
                    @if(rule.IsActive) { <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success"/> }
                    else { <MudIcon Icon="@Icons.Material.Filled.Cancel" Color="Color.Error"/> }
                </MudTd>
                <MudTd Style="vertical-align: top;">@rule.Name</MudTd>
                <MudTd Style="vertical-align: top;">
                    @if(rule.UseRegex)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Text">REGEX</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Text">EXACT</MudChip>
                    }
                    <code>@rule.Pattern</code>
                </MudTd>
                <MudTd Style="vertical-align: top;">
                    @if (rule.IsGlobal)
                    {
                        <MudText Color="Color.Info">Global</MudText>
                        @if(rule.ExcludedResources.Any())
                        {
                            <MudTooltip>
                                <ChildContent>
                                    <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Text">
                                        Excl: @rule.ExcludedResources.Count
                                    </MudChip>
                                </ChildContent>
                                <TooltipContent>
                                    @foreach (var excl in rule.ExcludedResources)
                                    {
                                        <div>@excl.Resource.Name</div>
                                    }
                                </TooltipContent>
                            </MudTooltip>
                        }
                    }
                    else
                    {
                         <MudText><b>@(rule.TargetResource?.Name ?? "N/A")</b></MudText>
                    }
                </MudTd>
                <MudTd Style="vertical-align: top;">
                    @(rule.BanDurationMinutes.HasValue ? $"{rule.BanDurationMinutes} min" : "Default")
                </MudTd>
                <MudTd Style="vertical-align: top;">
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" OnClick="@(() => OpenRuleDialog(rule))" />
                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Color="Color.Info" OnClick="@(() => CloneRule(rule))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => DeleteRule(rule))" />
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudTabPanel>

</MudTabs>

@code {
    private AppConfig _config = new();
    private List<WatchdogRule> _rules = new();
    private List<PangolinOrgEntry> _organizations = new();
    private bool _loadingOrgs = false;
    private PangolinOrgEntry? _selectedOrg = null;

    protected override void OnInitialized()
    {
        // Load Config
        var existingConfig = Db.Configurations.FirstOrDefault();
        if (existingConfig == null)
        {
            existingConfig = new AppConfig();
            Db.Configurations.Add(existingConfig);
            Db.SaveChanges();
        }
        _config = existingConfig;

        // Load Rules
        _rules = Db.Rules
            .Include(r => r.TargetResource)
            .Include(r => r.ExcludedResources)
            .ThenInclude(e => e.Resource)
            .ToList();
    }

    private void SaveConfig()
    {
        Db.SaveChanges();
        Snackbar.Add("Settings saved successfully!", Severity.Success);
    }

    private void OnOrgSelected(PangolinOrgEntry? org)
    {
        _selectedOrg = org;
        if (org != null)
        {
            _config.PangolinOrgId = org.OrgId;
        }
    }

    private async Task<IEnumerable<PangolinOrgEntry>> SearchOrgs(string value, CancellationToken token)
    {
        if(string.IsNullOrWhiteSpace(_config.PangolinApiUrl) || string.IsNullOrWhiteSpace(_config.PangolinApiToken))
        {
            Snackbar.Add("Please enter Pangolin API URL and Token first and click save!", Severity.Warning);
            return new List<PangolinOrgEntry>();
        }
        
        _loadingOrgs = true;
        StateHasChanged();

        try
        {
            _organizations = await PangolinConnector.GetOrgsAsync(_config);
            
            if (string.IsNullOrWhiteSpace(value))
            {
                return _organizations;
            }
            
            return _organizations
                .Where(o => o.OrgId.Contains(value, StringComparison.InvariantCultureIgnoreCase) || 
                           o.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load organizations: {ex.Message}", Severity.Error);
            return new List<PangolinOrgEntry>();
        }
        finally
        {
            _loadingOrgs = false;
            StateHasChanged();
        }
    }

    private async Task RefreshResources()
    {
        try
        {
            var resources = await PangolinConnector.GetResourcesAsync(_config);
            
            var existingPangolinIds = Db.Resources.Select(r => r.PangolinResourceId).ToList();
            var fetchedPangolinIds = resources.Select(r => r.ResourceId).ToList();
            
            var toDelete = existingPangolinIds.Except(fetchedPangolinIds).ToList();
            if (toDelete.Any())
            {
                var resourcesToDelete = Db.Resources.Where(r => toDelete.Contains(r.PangolinResourceId)).ToList();
                Db.Resources.RemoveRange(resourcesToDelete);
            }
            
            foreach (var resource in resources)
            {
                var existing = Db.Resources.FirstOrDefault(r => r.PangolinResourceId == resource.ResourceId);
                if (existing != null)
                {
                    existing.Name = resource.Name;
                    existing.FullDomain = resource.FullDomain;
                }
                else
                {
                    Db.Resources.Add(new Resource
                    {
                        PangolinResourceId = resource.ResourceId,
                        Name = resource.Name,
                        FullDomain = resource.FullDomain
                    });
                }
            }
            
            await Db.SaveChangesAsync();
            Snackbar.Add($"Resources refreshed! Synced {resources.Count} resources.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to refresh resources: {ex.Message}", Severity.Error);
        }
    }
    
    private async Task OpenIpWhitelistDialog()
    {
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true, NoHeader = true};
        var dialog = await DialogService.ShowAsync<Dialogs.IpWhitelistDialog>("Manage IP Whitelists", new DialogParameters(), options);
        await dialog.Result;
    }

    private async Task OpenRuleDialog(WatchdogRule? rule)
    {
        // if there is no resources in the system, sync them first
        if (!Db.Resources.Any())
        {
            Snackbar.Add("No resources found in the system. Fetching resources from Pangolin...", Severity.Info);
            await RefreshResources();
        }
        
        var isNew = rule == null;
        
        var ruleModel = isNew ? new WatchdogRule() : new WatchdogRule 
        { 
            Id = rule!.Id, 
            Name = rule.Name, 
            Pattern = rule.Pattern, 
            UseRegex = rule.UseRegex,
            IsGlobal = rule.IsGlobal, 
            TargetResourceId = rule.TargetResourceId,
            BanDurationMinutes = rule.BanDurationMinutes,
            IsActive = rule.IsActive,
            MaxPriority = rule.MaxPriority,
        };

        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true};
        var parameters = new DialogParameters<PangolinWatchdog.Components.Dialogs.RuleDialog> { { x => x.Rule, ruleModel } };
        var dialog = await DialogService.ShowAsync<PangolinWatchdog.Components.Dialogs.RuleDialog>(isNew ? "Add Rule" : "Edit Rule", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var savedRule = (WatchdogRule)result.Data;

            try
            {
                if (isNew)
                {
                    // When adding a new rule, EF will also try to insert any child entities
                    // that are present in savedRule.ExcludedResources.
                    var exclusionsToAdd = savedRule.ExcludedResources
                        .Select(e => new RuleResourceExclusion { ResourceId = e.ResourceId })
                        .ToList();

                    // Clear navigation to prevent EF from inserting them together with the rule
                    savedRule.ExcludedResources = new List<RuleResourceExclusion>();

                    Db.Rules.Add(savedRule);
                    Db.SaveChanges();

                    if (exclusionsToAdd.Any())
                    {
                        foreach (var exclusion in exclusionsToAdd)
                        {
                            exclusion.RuleId = savedRule.Id;
                            Db.RuleResourceExclusions.Add(exclusion);
                        }

                        Db.SaveChanges();
                    }
                }
                else
                {
                    var entity = Db.Rules.Include(r => r.ExcludedResources).First(r => r.Id == savedRule.Id);
                    entity.Name = savedRule.Name;
                    entity.Pattern = savedRule.Pattern;
                    entity.UseRegex = savedRule.UseRegex;
                    entity.IsGlobal = savedRule.IsGlobal;
                    entity.TargetResourceId = savedRule.TargetResourceId;
                    entity.BanDurationMinutes = savedRule.BanDurationMinutes;
                    entity.IsActive = savedRule.IsActive;
                    entity.MaxPriority = savedRule.MaxPriority;

                    Db.RuleResourceExclusions.RemoveRange(entity.ExcludedResources);

                    if (savedRule.ExcludedResources.Any())
                    {
                        foreach (var exclusion in savedRule.ExcludedResources)
                        {
                            exclusion.RuleId = entity.Id;
                            Db.RuleResourceExclusions.Add(exclusion);
                        }
                    }

                    Db.SaveChanges();
                }
            }
            catch (Exception e)
            {
                Snackbar.Add($"Failed to save rule: {e.Message}", Severity.Error);
                throw;
            }

            _rules = Db.Rules
                .Include(r => r.TargetResource)
                .Include(r => r.ExcludedResources)
                .ThenInclude(e => e.Resource)
                .ToList();
            Snackbar.Add("Rule saved!", Severity.Success);
        }
    }

    private Task CloneRule(WatchdogRule rule)
    {
        var clonedRule = new WatchdogRule
        {
            Name = $"{rule.Name} (Copy)",
            Pattern = rule.Pattern,
            UseRegex = rule.UseRegex,
            IsGlobal = rule.IsGlobal,
            TargetResourceId = rule.TargetResourceId,
            BanDurationMinutes = rule.BanDurationMinutes,
            IsActive = rule.IsActive
        };

        Db.Rules.Add(clonedRule);
        Db.SaveChanges();

        if (rule.ExcludedResources.Any())
        {
            foreach (var exclusion in rule.ExcludedResources)
            {
                Db.RuleResourceExclusions.Add(new RuleResourceExclusion
                {
                    RuleId = clonedRule.Id,
                    ResourceId = exclusion.ResourceId
                });
            }
            Db.SaveChanges();
        }

        _rules = Db.Rules
            .Include(r => r.TargetResource)
            .Include(r => r.ExcludedResources)
            .ThenInclude(e => e.Resource)
            .ToList();
        Snackbar.Add($"Rule '{rule.Name}' cloned successfully!", Severity.Success);
        
        return Task.CompletedTask;
    }

    private async Task DeleteRule(WatchdogRule rule)
    {
        var result = await DialogService.ShowMessageBox(
            "Warning", 
            $"Delete rule '{rule.Name}'?", 
            yesText:"Delete", cancelText:"Cancel");

        if (result == true)
        {
            Db.Rules.Remove(rule);
            Db.SaveChanges();
            _rules = Db.Rules
                .Include(r => r.TargetResource)
                .Include(r => r.ExcludedResources)
                .ThenInclude(e => e.Resource)
                .ToList();
            Snackbar.Add("Rule deleted.", Severity.Info);
        }
    }
}