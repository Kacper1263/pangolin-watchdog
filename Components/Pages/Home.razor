@page "/"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using PangolinWatchdog.Data
@attribute [Authorize]
@implements IDisposable 
@inject IDbContextFactory<AppDbContext> DbFactory
@rendermode InteractiveServer

<PageTitle>Dashboard</PageTitle>

<style>
    .filter-operator-popup {
        min-width: 70px !important;
    }
</style>

<MudGrid>
    <MudItem xs="12" sm="6" md="4">
        <MudPaper Class="pa-4 d-flex flex-column align-center justify-center mud-theme-primary">
            <MudText Typo="Typo.h3">@_activeBansCount</MudText>
            <MudText Typo="Typo.subtitle1">Active Bans (Now)</MudText>
        </MudPaper>
    </MudItem>
    
    <MudItem xs="12" sm="6" md="4">
        <MudPaper Class="pa-4 d-flex flex-column align-center justify-center mud-theme-secondary">
            <MudText Typo="Typo.h3">@_lastLogId</MudText>
            <MudText Typo="Typo.subtitle1">Last Processed Log ID</MudText>
        </MudPaper>
    </MudItem>
</MudGrid>

<MudText Typo="Typo.h5" Class="mt-8 mb-4">
    Ban History 
    <MudChip T="string" Color="Color.Success" Size="Size.Small" Icon="@Icons.Material.Filled.Autorenew" Class="ml-2">Auto-Refresh: @(_autoRefreshTimerSeconds)s</MudChip>
</MudText>

<MudTable @ref="_table" ServerData="@ServerReload" Dense="true" Hover="true" Breakpoint="Breakpoint.Sm" Elevation="4">
    <HeaderContent>
        <MudTh>
            <MudTableSortLabel SortLabel="IpAddress" T="BannedIp">IP Address</MudTableSortLabel>
            <MudTextField @bind-Value="_filters.IpAddress" Placeholder="Filter IP" Immediate="true" @bind-Value:after="OnFilterChanged" Clearable="true" />
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortLabel="Resource" T="BannedIp">Resource</MudTableSortLabel>
            <MudTextField @bind-Value="_filters.Resource" Placeholder="Filter Resource" Immediate="true" @bind-Value:after="OnFilterChanged" Clearable="true" />
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortLabel="Reason" T="BannedIp">Reason</MudTableSortLabel>
            <MudTextField @bind-Value="_filters.Reason" Placeholder="Filter Reason" Immediate="true" @bind-Value:after="OnFilterChanged" Clearable="true" />
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortLabel="BannedAt" InitialDirection="SortDirection.Descending" T="BannedIp">Banned At</MudTableSortLabel>
            <MudStack Row="true" Spacing="1">
                <MudSelect @bind-Value="_filters.BannedAtOperator" Placeholder="Op" Dense="true" @bind-Value:after="OnFilterChanged" PopoverClass="filter-operator-popup">
                    <MudSelectItem Value="@DateFilterOperator.None"></MudSelectItem>
                    <MudSelectItem Value="@DateFilterOperator.Equals">=</MudSelectItem>
                    <MudSelectItem Value="@DateFilterOperator.LessThan">&lt;</MudSelectItem>
                    <MudSelectItem Value="@DateFilterOperator.GreaterThan">&gt;</MudSelectItem>
                </MudSelect>
                <MudDatePicker @bind-Date="_filters.BannedAt" @bind-Date:after="OnFilterChanged" Placeholder="Date" Dense="true" Clearable="true" Style="min-width: 150px;" Disabled="@(_filters.BannedAtOperator == DateFilterOperator.None)" />
            </MudStack>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortLabel="ExpiresAt" T="BannedIp">Expires At</MudTableSortLabel>
            <MudStack Row="true" Spacing="1">
                <MudSelect @bind-Value="_filters.ExpiresAtOperator" Placeholder="Op" Dense="true" @bind-Value:after="OnFilterChanged" PopoverClass="filter-operator-popup">
                    <MudSelectItem Value="@DateFilterOperator.None"></MudSelectItem>
                    <MudSelectItem Value="@DateFilterOperator.Equals">=</MudSelectItem>
                    <MudSelectItem Value="@DateFilterOperator.LessThan">&lt;</MudSelectItem>
                    <MudSelectItem Value="@DateFilterOperator.GreaterThan">&gt;</MudSelectItem>
                    <MudSelectItem Value="@DateFilterOperator.IsNull">Empty</MudSelectItem>
                </MudSelect>
                <MudDatePicker @bind-Date="_filters.ExpiresAt" @bind-Date:after="OnFilterChanged" Placeholder="Date" Dense="true" Clearable="true" Style="min-width: 150px;" Disabled="@(_filters.ExpiresAtOperator == DateFilterOperator.None || _filters.ExpiresAtOperator == DateFilterOperator.IsNull)" />
            </MudStack>
        </MudTh>
        <MudTh>Status</MudTh>
    </HeaderContent>
    <RowTemplate Context="ban">
        <MudTd DataLabel="IP">
            <MudChip T="string" Color="Color.Error" Size="Size.Small" Variant="Variant.Text">@ban.IpAddress</MudChip>
        </MudTd>
        <MudTd DataLabel="Resource">
            <MudText Typo="Typo.body2">@ban.Resource.Name</MudText>
        </MudTd>
        <MudTd DataLabel="Reason">@ban.Reason</MudTd>
        <MudTd DataLabel="Date">@ban.BannedAt.ToString("dd/MM/yyyy HH:mm")</MudTd>
        <MudTd DataLabel="Expires">@ban.ExpiresAt?.ToString("dd/MM/yyyy HH:mm")</MudTd>
        <MudTd DataLabel="Status">
            @if (ban.ExpiresAt == null || ban.ExpiresAt > DateTime.Now)
            {
                 <MudIcon Icon="@Icons.Material.Filled.Lock" Color="Color.Error" Title="Active" Size="Size.Small"/>
            }
            else
            {
                 <MudIcon Icon="@Icons.Material.Filled.LockOpen" Color="Color.Success" Title="Expired" Size="Size.Small"/>
            }
        </MudTd>
    </RowTemplate>
    <NoRecordsContent>
        <MudText Class="pa-4" Align="Align.Center">Database is empty.</MudText>
    </NoRecordsContent>
    <PagerContent>
        <MudTablePager PageSizeOptions="new int[]{10, 25, 50, 100}" />
    </PagerContent>
</MudTable>

@code {
    private MudTable<BannedIp> _table = default!;
    private int _activeBansCount = 0;
    private long _lastLogId = 0;
    private int _autoRefreshTimerSeconds = 5;

    private PeriodicTimer? _timer;
    private readonly CancellationTokenSource _cts = new();
    
    private FilterModel _filters = new();
    
    protected override async Task OnInitializedAsync()
    {
        using (var db = await DbFactory.CreateDbContextAsync())
        {
             _activeBansCount = await db.BannedIps
                .CountAsync(b => b.ExpiresAt == null || b.ExpiresAt > DateTime.Now);
             
             var config = await db.Configurations.FirstOrDefaultAsync();
             if(config != null) _lastLogId = config.LastProcessedLogId;
        }

        _timer = new PeriodicTimer(TimeSpan.FromSeconds(_autoRefreshTimerSeconds));
        _ = RunAutoRefresh();
    }

    private async Task OnFilterChanged()
    {
        if (_table is not null)
        {
            await _table.ReloadServerData();
        }
    }

    private async Task RunAutoRefresh()
    {
        while (await _timer!.WaitForNextTickAsync(_cts.Token))
        {
            try
            {
                await InvokeAsync(async () =>
                {
                    if (_cts.IsCancellationRequested) return;
                    if (_table is not null)
                    {
                        await _table.ReloadServerData();
                        StateHasChanged();
                    }
                });
            }
            catch (Exception ex)
            {
                Console.WriteLine($"AutoRefresh Error: {ex.Message}");
            }
        }
    }

    private async Task<TableData<BannedIp>> ServerReload(TableState state, CancellationToken token)
    {
        using var db = await DbFactory.CreateDbContextAsync(token);

        var query = db.BannedIps.Include(b => b.Resource).AsQueryable();

        // Apply text filters (case-insensitive for SQLite)
        if (!string.IsNullOrWhiteSpace(_filters.IpAddress))
        {
            query = query.Where(b => EF.Functions.Like(b.IpAddress, $"%{_filters.IpAddress}%"));
        }

        if (!string.IsNullOrWhiteSpace(_filters.Resource))
        {
            query = query.Where(b => EF.Functions.Like(b.Resource.Name, $"%{_filters.Resource}%"));
        }

        if (!string.IsNullOrWhiteSpace(_filters.Reason))
        {
            query = query.Where(b => EF.Functions.Like(b.Reason, $"%{_filters.Reason}%"));
        }

        // Apply BannedAt date filter
        if (_filters.BannedAtOperator != DateFilterOperator.None && _filters.BannedAt.HasValue)
        {
            var filterDate = _filters.BannedAt.Value.Date;
            query = _filters.BannedAtOperator switch
            {
                DateFilterOperator.Equals => query.Where(b => b.BannedAt.Date == filterDate),
                DateFilterOperator.LessThan => query.Where(b => b.BannedAt.Date < filterDate),
                DateFilterOperator.GreaterThan => query.Where(b => b.BannedAt.Date > filterDate),
                _ => query
            };
        }

        // Apply ExpiresAt date filter
        if (_filters.ExpiresAtOperator != DateFilterOperator.None)
        {
            if (_filters.ExpiresAtOperator == DateFilterOperator.IsNull)
            {
                query = query.Where(b => !b.ExpiresAt.HasValue);
            }
            else if (_filters.ExpiresAt.HasValue)
            {
                var filterDate = _filters.ExpiresAt.Value.Date;
                query = _filters.ExpiresAtOperator switch
                {
                    DateFilterOperator.Equals => query.Where(b => b.ExpiresAt.HasValue && b.ExpiresAt.Value.Date == filterDate),
                    DateFilterOperator.LessThan => query.Where(b => b.ExpiresAt.HasValue && b.ExpiresAt.Value.Date < filterDate),
                    DateFilterOperator.GreaterThan => query.Where(b => b.ExpiresAt.HasValue && b.ExpiresAt.Value.Date > filterDate),
                    _ => query
                };
            }
        }

        query = state.SortLabel switch
        {
            "IpAddress" => query.OrderByDirection(state.SortDirection, o => o.IpAddress),
            "Reason" => query.OrderByDirection(state.SortDirection, o => o.Reason),
            "Resource" => query.OrderByDirection(state.SortDirection, o => o.Resource.Name),
            "ExpiresAt" => query.OrderByDirection(state.SortDirection, o => o.ExpiresAt),
            "BannedAt" => query.OrderByDirection(state.SortDirection, o => o.BannedAt),
            _ => query.OrderByDescending(o => o.BannedAt)
        };

        var totalItems = await query.CountAsync(token);
        var items = await query
            .Skip(state.Page * state.PageSize)
            .Take(state.PageSize)
            .ToListAsync(token);

        _activeBansCount = await db.BannedIps
            .CountAsync(b => b.ExpiresAt == null || b.ExpiresAt > DateTime.Now, token);

        var config = await db.Configurations.FirstOrDefaultAsync(token);
        if (config != null)
        {
            _lastLogId = config.LastProcessedLogId;
        }

        return new TableData<BannedIp> { TotalItems = totalItems, Items = items };
    }

    public void Dispose()
    {
        _cts.Cancel();
        _timer?.Dispose();
        _cts.Dispose();
    }

    private enum DateFilterOperator
    {
        None,
        Equals,
        LessThan,
        GreaterThan,
        IsNull
    }

    private class FilterModel
    {
        public string IpAddress { get; set; } = string.Empty;
        public string Resource { get; set; } = string.Empty;
        public string Reason { get; set; } = string.Empty;
        public DateTime? BannedAt { get; set; }
        public DateFilterOperator BannedAtOperator { get; set; } = DateFilterOperator.None;
        public DateTime? ExpiresAt { get; set; }
        public DateFilterOperator ExpiresAtOperator { get; set; } = DateFilterOperator.None;
    }
}