@page "/"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using PangolinWatchdog.Data
@attribute [Authorize]
@implements IDisposable 
@inject IDbContextFactory<AppDbContext> DbFactory
@rendermode InteractiveServer

<PageTitle>Dashboard</PageTitle>

<MudGrid>
    <MudItem xs="12" sm="6" md="4">
        <MudPaper Class="pa-4 d-flex flex-column align-center justify-center mud-theme-primary">
            <MudText Typo="Typo.h3">@_activeBansCount</MudText>
            <MudText Typo="Typo.subtitle1">Active Bans (Now)</MudText>
        </MudPaper>
    </MudItem>
    
    <MudItem xs="12" sm="6" md="4">
        <MudPaper Class="pa-4 d-flex flex-column align-center justify-center mud-theme-secondary">
            <MudText Typo="Typo.h3">@_lastLogId</MudText>
            <MudText Typo="Typo.subtitle1">Last Processed Log ID</MudText>
        </MudPaper>
    </MudItem>
</MudGrid>

<MudText Typo="Typo.h5" Class="mt-8 mb-4">
    Ban History 
    <MudChip T="string" Color="Color.Success" Size="Size.Small" Icon="@Icons.Material.Filled.Autorenew" Class="ml-2">Auto-Refresh: @(_autoRefreshTimerSeconds)s</MudChip>
</MudText>

<MudTable @ref="_table" ServerData="@ServerReload" Dense="true" Hover="true" Breakpoint="Breakpoint.Sm" Elevation="4">
    <HeaderContent>
        <MudTh><MudTableSortLabel SortLabel="IpAddress" T="BannedIp">IP Address</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="ResourceName" T="BannedIp">Resource</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="Reason" T="BannedIp">Reason</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="BannedAt" InitialDirection="SortDirection.Descending" T="BannedIp">Banned At</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortLabel="ExpiresAt" T="BannedIp">Expires At</MudTableSortLabel></MudTh>
        <MudTh>Status</MudTh>
    </HeaderContent>
    <RowTemplate Context="ban">
        <MudTd DataLabel="IP">
            <MudChip T="string" Color="Color.Error" Size="Size.Small" Variant="Variant.Text">@ban.IpAddress</MudChip>
        </MudTd>
        <MudTd DataLabel="Resource">
            <MudText Typo="Typo.body2">@ban.ResourceName</MudText>
            <MudText Typo="Typo.caption" Color="Color.Default">ID: @ban.ResourceId</MudText>
        </MudTd>
        <MudTd DataLabel="Reason">@ban.Reason</MudTd>
        <MudTd DataLabel="Date">@ban.BannedAt.ToString("dd/MM/yyyy HH:mm")</MudTd>
        <MudTd DataLabel="Expires">@ban.ExpiresAt?.ToString("dd/MM/yyyy HH:mm")</MudTd>
        <MudTd DataLabel="Status">
            @if (ban.ExpiresAt == null || ban.ExpiresAt > DateTime.Now)
            {
                 <MudIcon Icon="@Icons.Material.Filled.Lock" Color="Color.Error" Title="Active" Size="Size.Small"/>
            }
            else
            {
                 <MudIcon Icon="@Icons.Material.Filled.LockOpen" Color="Color.Success" Title="Expired" Size="Size.Small"/>
            }
        </MudTd>
    </RowTemplate>
    <NoRecordsContent>
        <MudText Class="pa-4" Align="Align.Center">Database is empty.</MudText>
    </NoRecordsContent>
    <PagerContent>
        <MudTablePager PageSizeOptions="new int[]{10, 25, 50, 100}" />
    </PagerContent>
</MudTable>

@code {
    private MudTable<BannedIp> _table = default!;
    private int _activeBansCount = 0;
    private long _lastLogId = 0;
    private int _autoRefreshTimerSeconds = 5;

    private PeriodicTimer? _timer;
    private readonly CancellationTokenSource _cts = new();
    
    protected override async Task OnInitializedAsync()
    {
        using (var db = await DbFactory.CreateDbContextAsync())
        {
             _activeBansCount = await db.BannedIps
                .CountAsync(b => b.ExpiresAt == null || b.ExpiresAt > DateTime.Now);
             
             var config = await db.Configurations.FirstOrDefaultAsync();
             if(config != null) _lastLogId = config.LastProcessedLogId;
        }

        _timer = new PeriodicTimer(TimeSpan.FromSeconds(_autoRefreshTimerSeconds));
        _ = RunAutoRefresh();
    }

    private async Task RunAutoRefresh()
    {
        while (await _timer!.WaitForNextTickAsync(_cts.Token))
        {
            try
            {
                await InvokeAsync(async () =>
                {
                    if (_cts.IsCancellationRequested) return;
                    if (_table is not null)
                    {
                        await _table.ReloadServerData();
                        StateHasChanged();
                    }
                });
            }
            catch (Exception ex)
            {
                Console.WriteLine($"AutoRefresh Error: {ex.Message}");
            }
        }
    }

    private async Task<TableData<BannedIp>> ServerReload(TableState state, CancellationToken token)
    {
        using var db = await DbFactory.CreateDbContextAsync(token);

        var query = db.BannedIps.AsQueryable();

        query = state.SortLabel switch
        {
            "IpAddress" => query.OrderByDirection(state.SortDirection, o => o.IpAddress),
            "ResourceName" => query.OrderByDirection(state.SortDirection, o => o.ResourceName),
            "Reason" => query.OrderByDirection(state.SortDirection, o => o.Reason),
            "ExpiresAt" => query.OrderByDirection(state.SortDirection, o => o.ExpiresAt),
            "BannedAt" => query.OrderByDirection(state.SortDirection, o => o.BannedAt),
            _ => query.OrderByDescending(o => o.BannedAt)
        };

        var totalItems = await query.CountAsync(token);
        var items = await query
            .Skip(state.Page * state.PageSize)
            .Take(state.PageSize)
            .ToListAsync(token);

        _activeBansCount = await db.BannedIps
            .CountAsync(b => b.ExpiresAt == null || b.ExpiresAt > DateTime.Now, token);

        var config = await db.Configurations.FirstOrDefaultAsync(token);
        if (config != null)
        {
            _lastLogId = config.LastProcessedLogId;
        }

        return new TableData<BannedIp> { TotalItems = totalItems, Items = items };
    }

    public void Dispose()
    {
        _cts.Cancel();
        _timer?.Dispose();
        _cts.Dispose();
    }
}